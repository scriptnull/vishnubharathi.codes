<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Vishnu Bharathi</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://vishnubharathi.codes/"/>
  <updated>2024-05-21T05:00:55.158Z</updated>
  <id>https://vishnubharathi.codes/</id>
  
  <author>
    <name>Vishnu Bharathi</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Exploring Middlewares in Go</title>
    <link href="https://vishnubharathi.codes/blog/exploring-middlewares-in-go/"/>
    <id>https://vishnubharathi.codes/blog/exploring-middlewares-in-go/</id>
    <published>2024-05-20T18:40:08.000Z</published>
    <updated>2024-05-21T05:00:55.158Z</updated>
    
    <content type="html"><![CDATA[<p>I came across ‚ÄúMiddlewares‚Äù for writing HTTP servers originally in the Node.js ecosystem. There is this beautiful library called <a href="https://expressjs.com/">express</a> which sparked the joy of middlewares in me. In case if you haven‚Äôt heard of middlewares before, I think you should read <a href="https://expressjs.com/en/guide/using-middleware.html">this beautiful page</a> from expressjs documentation to get a taste of them. (I genuinely feel that it is the best possible introduction for middleware, hence opening up the post with it)</p><p>With enough JavaScript for the day, we will jump into Go now. üòÖ</p><p>My goal for this post is to understand how to {use, write} middlewares in Go HTTP servers. We will also try to search the internet and surface some Go middlewares that we can add to our day to day toolkit.</p><h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>Let us take a simple problem and work our way upwards. Here is the problem statement:</p><p>Write a HTTP server that contains multiple routes. When a request is made to a route, print a log line at the start and the end of the request. Something like</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2024&#x2F;05&#x2F;21 00:49:32 INFO start method&#x3D;GET path&#x3D;&#x2F;one</span><br><span class="line">2024&#x2F;05&#x2F;21 00:49:32 INFO end method&#x3D;GET path&#x3D;&#x2F;one</span><br><span class="line">2024&#x2F;05&#x2F;21 00:49:34 INFO start method&#x3D;GET path&#x3D;&#x2F;two</span><br><span class="line">2024&#x2F;05&#x2F;21 00:49:34 INFO end method&#x3D;GET path&#x3D;&#x2F;two</span><br></pre></td></tr></table></figure><h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><h3 id="Without-Middleware"><a href="#Without-Middleware" class="headerlink" title="Without Middleware"></a>Without Middleware</h3><p>A solution without using middlewares would look like</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log/slog&quot;</span></span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">http.HandleFunc(<span class="string">&quot;/one&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">slog.Info(<span class="string">&quot;start&quot;</span>, <span class="string">&quot;method&quot;</span>, r.Method, <span class="string">&quot;path&quot;</span>, r.URL.Path)</span><br><span class="line"><span class="keyword">defer</span> slog.Info(<span class="string">&quot;end&quot;</span>, <span class="string">&quot;method&quot;</span>, r.Method, <span class="string">&quot;path&quot;</span>, r.URL.Path)</span><br><span class="line"></span><br><span class="line">fmt.Fprintln(w, <span class="string">&quot;this is one&quot;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">http.HandleFunc(<span class="string">&quot;/two&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">slog.Info(<span class="string">&quot;start&quot;</span>, <span class="string">&quot;method&quot;</span>, r.Method, <span class="string">&quot;path&quot;</span>, r.URL.Path)</span><br><span class="line"><span class="keyword">defer</span> slog.Info(<span class="string">&quot;end&quot;</span>, <span class="string">&quot;method&quot;</span>, r.Method, <span class="string">&quot;path&quot;</span>, r.URL.Path)</span><br><span class="line"></span><br><span class="line">fmt.Fprintln(w, <span class="string">&quot;this is two&quot;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">http.ListenAndServe(<span class="string">&quot;:3000&quot;</span>, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>How do we avoid copy pasting those two lines to every HTTP handler function? Middlewares for the win!</p><h3 id="Basic-Middleware"><a href="#Basic-Middleware" class="headerlink" title="Basic Middleware"></a>Basic Middleware</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log/slog&quot;</span></span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">logRequest</span><span class="params">(next <span class="keyword">func</span>(http.ResponseWriter, *http.Request)</span>) <span class="title">func</span><span class="params">(http.ResponseWriter, *http.Request)</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">slog.Info(<span class="string">&quot;start&quot;</span>, <span class="string">&quot;method&quot;</span>, r.Method, <span class="string">&quot;path&quot;</span>, r.URL.Path)</span><br><span class="line"><span class="keyword">defer</span> slog.Info(<span class="string">&quot;end&quot;</span>, <span class="string">&quot;method&quot;</span>, r.Method, <span class="string">&quot;path&quot;</span>, r.URL.Path)</span><br><span class="line"></span><br><span class="line">next(w, r)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">oneHandler</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">fmt.Fprintln(w, <span class="string">&quot;this is one&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">twoHander</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">fmt.Fprintln(w, <span class="string">&quot;this is two&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">http.HandleFunc(<span class="string">&quot;/one&quot;</span>, logRequest(oneHandler))</span><br><span class="line">http.HandleFunc(<span class="string">&quot;/two&quot;</span>, logRequest(twoHander))</span><br><span class="line"></span><br><span class="line">http.ListenAndServe(<span class="string">&quot;:3000&quot;</span>, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Using-http-HandleFunc"><a href="#Using-http-HandleFunc" class="headerlink" title="Using http.HandleFunc"></a>Using http.HandleFunc</h3><p>We are not done yet! There is still room for improvement. Notice how big the method signature for <code>logRequest</code> is! we can start from there. I remember a standard library type called <code>http.HandlerFunc</code> which could be used in the place of <code>func(ResponseWriter, *Request)</code>. If we start using it, our middleware looks like this.</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">logRequest</span><span class="params">(next http.HandlerFunc)</span> <span class="title">http</span>.<span class="title">HandlerFunc</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">slog.Info(<span class="string">&quot;start&quot;</span>, <span class="string">&quot;method&quot;</span>, r.Method, <span class="string">&quot;path&quot;</span>, r.URL.Path)</span><br><span class="line"><span class="keyword">defer</span> slog.Info(<span class="string">&quot;end&quot;</span>, <span class="string">&quot;method&quot;</span>, r.Method, <span class="string">&quot;path&quot;</span>, r.URL.Path)</span><br><span class="line"></span><br><span class="line">next(w, r)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>While browsing through the Go docs, I noticed that <code>http.HandleFunc</code> to have the below method signature.</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">HandleFunc</span><span class="params">(pattern <span class="keyword">string</span>, handler <span class="keyword">func</span>(ResponseWriter, *Request)</span>)</span></span><br></pre></td></tr></table></figure><p>That arose a question in me. Why don‚Äôt they use <code>func HandleFunc(pattern string, handler http.HandlerFunc)</code> instead? I thought <code>http.HandlerFunc</code> is an alias type for <code>func(ResponseWriter, *Request)</code>. Digging through the standard library source code had the answer. It seems like it is just not a simple alias, but more than that. Copy pasting the implementation of <code>http.HanderFunc</code> for you straight out of Go source :D</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The HandlerFunc type is an adapter to allow the use of</span></span><br><span class="line"><span class="comment">// ordinary functions as HTTP handlers. If f is a function</span></span><br><span class="line"><span class="comment">// with the appropriate signature, HandlerFunc(f) is a</span></span><br><span class="line"><span class="comment">// [Handler] that calls f.</span></span><br><span class="line"><span class="keyword">type</span> HandlerFunc <span class="function"><span class="keyword">func</span><span class="params">(ResponseWriter, *Request)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ServeHTTP calls f(w, r).</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f HandlerFunc)</span> <span class="title">ServeHTTP</span><span class="params">(w ResponseWriter, r *Request)</span></span> &#123;</span><br><span class="line">f(w, r)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>oh wow, so http.HandleFunc is a <code>func(ResponseWriter, *Request)</code> which implements the <a href="https://pkg.go.dev/net/http#Handler">http.Handler</a> interface.</p><h3 id="Enter-http-Handler"><a href="#Enter-http-Handler" class="headerlink" title="Enter http.Handler"></a>Enter http.Handler</h3><p>Why would we need an adapter like <code>http.HandlerFunc</code> that implements the <code>http.Handler</code> interface. To understand, let us take a look at the interface definition.</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Handler <span class="keyword">interface</span> &#123;</span><br><span class="line">ServeHTTP(ResponseWriter, *Request)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>and also read through the <a href="https://pkg.go.dev/net/http#Handler">http.Handler documentation</a>. At first, it didn‚Äôt solve my doubt, but then I discovered <a href="https://pkg.go.dev/net/http#example-Handle">this beautiful example</a> in the docs. Copy pasting the example from the docs here for you to have a quick look.</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"><span class="string">&quot;sync&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> countHandler <span class="keyword">struct</span> &#123;</span><br><span class="line">mu sync.Mutex <span class="comment">// guards n</span></span><br><span class="line">n  <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *countHandler)</span> <span class="title">ServeHTTP</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">h.mu.Lock()</span><br><span class="line"><span class="keyword">defer</span> h.mu.Unlock()</span><br><span class="line">h.n++</span><br><span class="line">fmt.Fprintf(w, <span class="string">&quot;count is %d\n&quot;</span>, h.n)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">http.Handle(<span class="string">&quot;/count&quot;</span>, <span class="built_in">new</span>(countHandler))</span><br><span class="line">log.Fatal(http.ListenAndServe(<span class="string">&quot;:8080&quot;</span>, <span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>wow, did you get it? Sometimes your handler is more than just a <code>func(http.ResponseWriter, *http.Request)</code>. It could be a struct that contains data that could be used in your request logic. Like in the above case, <code>countHandler</code> maintains a counter protected by a mutex. Each and every request to <code>/count</code> would increment the counter atomically.</p><p>For simple routes, which is just a bunch of instructions we could use <code>http.HandleFunc</code>. But once your handler gets complex, like having to maintain data that is common to all requests of the handler, then move upward and go for <code>http.Handle</code>.</p><p>woah, this just cleared my long standing doubt about ‚Äúwhen to use <code>http.Handle</code> and <code>http.HandleFunc</code>?‚Äù</p><p>It is getting a bit clear now on why the <code>http.Handler</code> interface is needed. With two ways of defining a HTTP handler: one being wrte a <code>func(http.ResponseWriter, *http.Request)</code> and pass it to <code>http.HandleFunc</code> and another being write a struct with the necessary logic and pass it down to <code>http.Handle</code> function, the standard libary needs a common ground in which all its methods can operate on both the types of handlers. Hence an interface.</p><h3 id="http-HandlerFunc-to-http-Handler"><a href="#http-HandlerFunc-to-http-Handler" class="headerlink" title="http.HandlerFunc to http.Handler"></a>http.HandlerFunc to http.Handler</h3><p>Now that it is evident that a Go programmer could choose between using <code>http.Handle</code> or <code>http.HandleFunc</code> to serve their handlers, it is necessry that any HTTP middleware should work for both of those use-cases. With the current approach to our solution, we will only support middlerwares which are input to <code>http.HandleFunc</code>. Hance moving our middleware to use <code>http.Handler</code> interface, that way we could accommodate both types of handlers.</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log/slog&quot;</span></span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">logRequest</span><span class="params">(next http.Handler)</span> <span class="title">http</span>.<span class="title">Handler</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> http.HandlerFunc(<span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">slog.Info(<span class="string">&quot;start&quot;</span>, <span class="string">&quot;method&quot;</span>, r.Method, <span class="string">&quot;path&quot;</span>, r.URL.Path)</span><br><span class="line"><span class="keyword">defer</span> slog.Info(<span class="string">&quot;end&quot;</span>, <span class="string">&quot;method&quot;</span>, r.Method, <span class="string">&quot;path&quot;</span>, r.URL.Path)</span><br><span class="line"></span><br><span class="line">next.ServeHTTP(w, r)</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">oneHandler</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">fmt.Fprintln(w, <span class="string">&quot;this is one&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">twoHander</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">fmt.Fprintln(w, <span class="string">&quot;this is two&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">http.Handle(<span class="string">&quot;/one&quot;</span>, logRequest(http.HandlerFunc(oneHandler)))</span><br><span class="line">http.Handle(<span class="string">&quot;/two&quot;</span>, logRequest(http.HandlerFunc(twoHander)))</span><br><span class="line"></span><br><span class="line">http.ListenAndServe(<span class="string">&quot;:3000&quot;</span>, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Standard-library-Middlewares"><a href="#Standard-library-Middlewares" class="headerlink" title="Standard library Middlewares"></a>Standard library Middlewares</h2><p>The <code>net/http</code> package in the standard library of Go contains middlewares. If you haven‚Äôt realized it yet, don‚Äôt worry. That is because they don‚Äôt advertise those functions as ‚Äúmiddleware‚Äù (ctrl+f on docs for middleware leaves you with 0 matches :D)</p><h3 id="AllowQuerySemicolons"><a href="#AllowQuerySemicolons" class="headerlink" title="AllowQuerySemicolons"></a>AllowQuerySemicolons</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">AllowQuerySemicolons</span><span class="params">(h Handler)</span> <span class="title">Handler</span></span></span><br></pre></td></tr></table></figure><p>TIL that we could use semicolons instead of ampersand in query strings (though this style is deprecated by W3C). Read more about it here: <a href="https://github.com/golang/go/issues/25192">https://github.com/golang/go/issues/25192</a>. This middleware is present in the stdlib for soving that problem by replacing the <code>;</code> with <code>&amp;</code> under the hood. </p><h3 id="MaxBytesHandler"><a href="#MaxBytesHandler" class="headerlink" title="MaxBytesHandler"></a>MaxBytesHandler</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MaxBytesHandler</span><span class="params">(h Handler, n <span class="keyword">int64</span>)</span> <span class="title">Handler</span></span></span><br></pre></td></tr></table></figure><p>This could be used to limit the acceptable request body size. Under the hood it uses <code>MaxBytesReader</code>:</p><blockquote><p>MaxBytesReader prevents clients from accidentally or maliciously sending a large request and wasting server resources. If possible, it tells the ResponseWriter to close the connection after the limit has been reached.</p></blockquote><h3 id="StripPrefix"><a href="#StripPrefix" class="headerlink" title="StripPrefix"></a>StripPrefix</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">StripPrefix</span><span class="params">(prefix <span class="keyword">string</span>, h Handler)</span> <span class="title">Handler</span></span></span><br></pre></td></tr></table></figure><p>The docs says</p><blockquote><p>StripPrefix returns a handler that serves HTTP requests by removing the given prefix from the request URL‚Äôs Path (and RawPath if set) and invoking the handler h.</p></blockquote><p>My first impression is how could this be useful. Oh, wait for the blast! Here we go once again with a beautiful copy paste of an stdlib example.</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// To serve a directory on disk (/tmp) under an alternate URL</span></span><br><span class="line"><span class="comment">// path (/tmpfiles/), use StripPrefix to modify the request</span></span><br><span class="line"><span class="comment">// URL&#x27;s path before the FileServer sees it:</span></span><br><span class="line">http.Handle(<span class="string">&quot;/tmpfiles/&quot;</span>, http.StripPrefix(<span class="string">&quot;/tmpfiles/&quot;</span>, http.FileServer(http.Dir(<span class="string">&quot;/tmp&quot;</span>))))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="TimeoutHandler"><a href="#TimeoutHandler" class="headerlink" title="TimeoutHandler"></a>TimeoutHandler</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TimeoutHandler</span><span class="params">(h Handler, dt time.Duration, msg <span class="keyword">string</span>)</span> <span class="title">Handler</span></span></span><br></pre></td></tr></table></figure><p>Like the name says, it times out the handler if the request is taking more than the given duration.</p><h2 id="Third-party-Middlewares"><a href="#Third-party-Middlewares" class="headerlink" title="Third-party Middlewares"></a>Third-party Middlewares</h2><p>I came across this beautiful library called <code>chi</code> which comes loaded up with a bunch of middlewares out of the box: <a href="https://github.com/go-chi/chi?tab=readme-ov-file#middlewares">https://github.com/go-chi/chi?tab=readme-ov-file#middlewares</a></p><p>I would suggest starting with the default chi recommendation:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A good base middleware stack</span></span><br><span class="line">r.Use(middleware.RequestID)</span><br><span class="line">r.Use(middleware.RealIP)</span><br><span class="line">r.Use(middleware.Logger)</span><br><span class="line">r.Use(middleware.Recoverer)</span><br></pre></td></tr></table></figure><p>and then build up the chain. Go explore and catch ‚Äòem all!</p><p>(also let me know your favorite middlewares if you have one - because I am trying to discover more third party middlewares in Go)</p><h2 id="Communicate"><a href="#Communicate" class="headerlink" title="Communicate"></a>Communicate</h2><p>When writing or using middlewares, you may need to pass down a variable that was created by one middleware into another middleware or in the request handler. In case of JS, we would just mutate the <code>request</code> object directly since it is dynamically typed :D (lol, good old days). In case of Go, we can‚Äôt do that and we will need a way of passing through variable of any type via the available <code>ResponseWriter</code> or <code>Request</code> objects.</p><p>I have previously written a whole blog post on the <a href="https://vishnubharathi.codes/blog/context-with-value-pitfall">pitfalls of context.WithValue</a> and when not to use them. And well, this is actually the use-case where you can use them!</p><p>A context variable is available to you in all the middlewares and the handlers via the <code>http.Request</code> object. We could use that to store and pass down information. </p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">type</span> RequestKey <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">RequestIDKey RequestKey = <span class="string">&quot;request-id&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RequestID</span><span class="params">(next http.Handler)</span> <span class="title">http</span>.<span class="title">Handler</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> http.HandlerFunc(<span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">ctx := context.WithValue(r.Context(), RequestIDKey, uuid.New())</span><br><span class="line">next.ServeHTTP(w, r.WithContext(ctx))</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handlerThatUsesRequestID</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">reqID, ok := r.Context().Value(RequestIDKey).(uuid.UUID)</span><br><span class="line"><span class="keyword">if</span> !ok || reqID == uuid.Nil &#123;</span><br><span class="line">fmt.Fprintln(w, <span class="string">&quot;this a request without requestID&quot;</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">fmt.Fprintf(w, <span class="string">&quot;request id is %s\n&quot;</span>, reqID)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>You still need to be careful while using <code>context.WithValue</code>. What if you miss calling a middleware, but try to look up the value that it is supposed to set in <code>r.Context</code>? It changes the trajectory of your request during runtime and in the worst-case it will lead to runtime panics in your handler. I am wondering if we could somehow catch this kind of stuff during compile time (like maybe by writing a library or perhaps someone already thought about this before - if so, let me know!)</p><h2 id="Chain"><a href="#Chain" class="headerlink" title="Chain"></a>Chain</h2><p>You might soon end up having to call multiple middlewares for your handlers. In that case, your code would look like:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// middlewares for unauthenticated routes</span></span><br><span class="line">http.Handle(<span class="string">&quot;/&quot;</span>, Logger(RequestID(homeHandler))))</span><br><span class="line"></span><br><span class="line"><span class="comment">// middlewares for authenticated routes</span></span><br><span class="line">http.Handle(<span class="string">&quot;/profile&quot;</span>, Logger(RequestID(BasicAuth(userProfileHandler)))))</span><br></pre></td></tr></table></figure><p>We need a way to chain the middlewares and store the chain so that we can re-use it between handlers. I recently discovered a library for this, which might help here: <a href="https://github.com/justinas/alice">https://github.com/justinas/alice</a></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">unAuth := alice.New(Logger, RequestID)</span><br><span class="line">auth := alice.New(Logger, RequestID, BasicAuth)</span><br><span class="line"></span><br><span class="line">http.Handle(<span class="string">&quot;/&quot;</span>, unAuth.Then(homeHandler))</span><br><span class="line">http.Handle(<span class="string">&quot;/profile&quot;</span>, auth.Then(userProfileHandler))</span><br></pre></td></tr></table></figure><p>You can also use routing library lke <code>chi</code> where the request middlewares are defined at the router level.</p><h2 id="Closing-Thoughts"><a href="#Closing-Thoughts" class="headerlink" title="Closing Thoughts"></a>Closing Thoughts</h2><p>I hope this exploration was useful to you! It definitely made me learn some unexpected things like ‚Äúwhen to use http.Handle? when to use http.HandleFunc? ‚Ä¶.‚Äù. This is also inspiring me to write a small middleware library that I have been thinking about.</p><p>~ ~ ~ ~</p><p>In an alternate universe, someone declared <code>type Middleware func(Handler) Handler</code> in <code>net/http</code> and (use your imagination).</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;I came across ‚ÄúMiddlewares‚Äù for writing HTTP servers originally in the Node.js ecosystem. There is this beautiful library called &lt;a href=
      
    
    </summary>
    
    
      <category term="go" scheme="https://vishnubharathi.codes/tags/go/"/>
    
  </entry>
  
  <entry>
    <title>Rough notes on GCP networking</title>
    <link href="https://vishnubharathi.codes/blog/rough-notes-on-google-cloud-networking/"/>
    <id>https://vishnubharathi.codes/blog/rough-notes-on-google-cloud-networking/</id>
    <published>2024-03-11T00:52:46.000Z</published>
    <updated>2024-05-21T05:00:55.162Z</updated>
    
    <content type="html"><![CDATA[<p>I am publishing my rough notes on Google Cloud networking which I collected while watching the first few episodes of the <a href="https://www.youtube.com/watch?v=0hN-dyOV10c&amp;list=PLDGXb-1k3XY1RaEfzp_nDSJMPP0iAQEtP">Google Cloud Networking playlist</a>. lol, I don‚Äôt know how many more times I will need to revise them.</p><p>(Any images seen here are attributed to the presentation in the video series mentioned above. This blog post is more like watching those videos on fast-forward and I would definitely encourage you to check out the videos if you would like more clarity)</p><h2 id="VPC"><a href="#VPC" class="headerlink" title="VPC"></a>VPC</h2><ul><li>VPC is a global construct<ul><li>You can create subnets that belong to a different region</li></ul></li><li>Shared VPC<ul><li>One host project has VPC and subnets</li><li>Share all or some subnets with other projects that host the project-level service</li></ul></li></ul><h2 id="Interconnecting-to-Google-Cloud"><a href="#Interconnecting-to-Google-Cloud" class="headerlink" title="Interconnecting to Google Cloud"></a>Interconnecting to Google Cloud</h2><ul><li>Layer 3<ul><li>Dedicated (Direct peering)</li><li>Shared (Carrier peering)</li><li>Needs VPN setup to tunnel into private address space</li><li>No SLAs</li><li>Free of cost (but check latest)</li></ul></li><li>Layer 2<ul><li>Dedicated Interconnect<ul><li>Costly (because Gcloud has dedicated hardware)</li><li>Dedicated bandwidth</li></ul></li><li>Partner Interconnect<ul><li>Example: Equinix fabric</li><li>Shared bandwidth other people who are using the interconnect</li></ul></li><li>Has SLA</li></ul></li></ul><h2 id="Routing"><a href="#Routing" class="headerlink" title="Routing"></a>Routing</h2><ul><li>Pre-programmed routes<ul><li>Automatically created.</li><li>User can‚Äôt delete or change these routes</li><li>Subnet routes are automatically created when a subnet is added to the network</li></ul></li><li>Default routes<ul><li>Pre-programmed 0.0.0.0/0 route to an internet gateway</li><li>Unlike pre-programmed routes, this can be changed.</li></ul></li><li>Cloud Router (CR)<ul><li>Cloud Router is similar to a traditional router but has differences that are important to understand</li><li>In a traditional router, a router provides two functionalities<ul><li>Control plane functionality - BGP route communication mechanisms.</li><li>Data plane functionality - packets go into the router and the router makes the decision of where to route it.</li></ul></li><li>Cloud router is a ‚Äúcontrol-plane‚Äù only device. Think about it as a BGP speaker. This only speaks BGP, but the routers that you have on-prem might speak other protocols.</li><li>What does Cloud Router do?<ul><li>Learns routes dynamically, configures routing tables, and pushes those routing tables to the VMs themselves.</li><li>So when a VM wants to send packets to another VM, it is a host-to-host communication rather than pushing the packet to a router and the router making a choice to reach the destination.</li></ul></li><li>It is a Google-managed process, controlled by you, that runs on a Google host. If it fails, Google Cloud will automatically try to restart it. However, the routing from host to host is not affected during this period since it is not a data plane device. BGP connectivity will be lost during this time, so you can‚Äôt add new routes. The best practice would be to run two cloud routers always.</li><li>Two routing modes<ul><li>(can be enabled when setting up your VPC)</li><li>Regional routing<ul><li>CR was brought up in a region. So it can only learn about the subnets in that particular region.</li><li>Be careful about using these because when a load balancer tries to reach something in us-west-1 but the request ends up in the CR present in us-east-1, then a black hole is created. (i.e. request is not able to be routed to us-west-1 because regional CR doesn‚Äôt even know that us-west-1 exists)</li></ul></li><li>Global routing<ul><li>Allows CR to pick up all the subnets in a VPC</li></ul></li></ul></li><li>Route Priority<ul><li>Route Priority is equivalent to the BGP MED metric (multi-exit discriminator)</li><li>Local routes have default MED (1000 if not changed)</li><li>Routes from other regions have a metric based on RTT added to the default MED value.</li><li>If you have multiple interconnects, you can use route priority to tell the preference order of where the request needs to go.</li></ul></li></ul></li><li>Advanced Route<ul><li>Static forwarding to a VPN gateway when cloud routers/dynamic routing isn‚Äôt used.</li><li>Force some IPs to be routed to a third-party service</li></ul></li></ul><h2 id="VPC-Peering"><a href="#VPC-Peering" class="headerlink" title="VPC Peering"></a>VPC Peering</h2><ul><li>In case of VPNs, you can adverstise only a few subnets between network. In case of VPC peering, it is binary. All subnets in VPC A will get advertised to all subnets in VPC B and vice versa. You are basically smashing two VPCs.</li><li>Security policies still exist in both the VPCs and there is no ‚Äúsingle‚Äù security policy for the smashed up VPC. So, if something is going wrong, check the firewall rules associated with both VPCs.</li><li>Can not have overlapping IP ranges</li><li>Non-transitive in nature</li><li>Quotas and Limits:<ul><li>15,500 total VMs across all peering relationships</li><li>A network can have upto 25 peered networks</li></ul></li></ul><h2 id="Load-Balancers"><a href="#Load-Balancers" class="headerlink" title="Load Balancers"></a>Load Balancers</h2><ul><li>Families (based on where they face)<ul><li>External load balancer: Internet-facing</li><li>Internal load balancer: Internal to google cloud</li></ul></li><li>Families (based on where they route to)<ul><li>Global</li><li>Regional</li></ul></li><li>Families (based on the level they operate at)<ul><li>Network Load balancers<ul><li>Layer 3 and 4.</li><li>These are external load balancers (internet-facing)</li><li>These are regional load balancers.</li><li>Highly available with multiple zones</li><li>Load balance TCP/UDP traffic and does not look at L7</li><li>Client IP is preserved, don‚Äôt need x-forwarded-for</li><li>It does not perform SSL termination, so your backend needs to do it</li><li>Client access can be controlled with the VPC Firewall</li><li>Balances traffic using 2, 3, or 5-tuple hashing<ul><li>2 tuple: {sourceIp, destIP}</li><li>3 tuple: {sourceIp, destIP, Protocol}</li><li>5 tuple: {sourceIp, destIP, sourcePort, destPort, Protocol}</li></ul></li><li>Session Affinity based on IP address</li><li>High performance = 1 million+ requests per second</li></ul></li><li>DNS-based Global LB<ul><li>This is how traditional public cloud usually had load balancing. But not how Google cloud load balancing works.</li><li><img src="https://github.com/scriptnull/vishnubharathi.codes/assets/4211715/145bb23d-d996-4292-bf20-26cbfc880b2b" alt="image"></li><li>IP address of servers in different region are added as DNS entries for the domain.</li><li>The DNS server gives back the IP address when requested in a load balancer fashion (like round robin)</li><li>Disadvantage: DNS caching happens at multiple places (web browsers, internet providers ec.), so it might be pointing to a invalid IP address at one of those layers</li></ul></li><li>Google Global Load Balancer (L7)<ul><li>Built for powering Google search, Gmail and other Google products and then adopted inside Google cloud</li><li><img src="https://github.com/scriptnull/vishnubharathi.codes/assets/4211715/0e178e1f-c9c9-472b-9506-f76385ae5870" alt="image"></li></ul></li><li>Single Global Anycast VIP (IPv4/IPv6) across region</li><li>Cross-region failure and fallback</li><li>Fast autoscaling</li><li>Highly available</li><li>Single point to apply global policies</li></ul></li><li>Internal Load Balancers<ul><li><img src="https://github.com/scriptnull/vishnubharathi.codes/assets/4211715/e918cf25-7f13-4697-8fb2-a8550125a5b0" alt="image"></li></ul></li><li>L4 Regional LB<ul><li>Internal (RFC 1918) VIP</li><li>Client IP Preserved</li><li>TCP, HTTP, HTTPS health checks</li><li>No middle proxy (delivered through SDN), High performance, and no chokepoints</li></ul></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;I am publishing my rough notes on Google Cloud networking which I collected while watching the first few episodes of the &lt;a href=&quot;https:/
      
    
    </summary>
    
    
      <category term="devops" scheme="https://vishnubharathi.codes/tags/devops/"/>
    
      <category term="cloud" scheme="https://vishnubharathi.codes/tags/cloud/"/>
    
  </entry>
  
  <entry>
    <title>Infinite ways</title>
    <link href="https://vishnubharathi.codes/blog/infinite-ways/"/>
    <id>https://vishnubharathi.codes/blog/infinite-ways/</id>
    <published>2024-01-12T22:40:00.000Z</published>
    <updated>2024-05-21T05:00:55.158Z</updated>
    
    <content type="html"><![CDATA[<p>I was reading through the <a href="https://lamport.azurewebsites.net/tla/book-21-07-04.pdf">Specifying systems</a> book few hours back where I came across this beautiful insight.</p><blockquote><p>Mathematics provides infinitely many ways of expressing the same thing</p></blockquote><p>Take the number 12. There are infinite number of ways to express it.</p><p>expr 1) 6 + 6</p><p>expr 2) 3 * 4</p><p>expr 3) 141 - 129</p><p>expr 4) 4353475 - (4353462 + 1)</p><p>All the above expressions evaluate to 12. When options are infinte, how to express something?</p><p>The same question applies to writing formal specifications and programming.</p><p>The advice from the book is simple:</p><blockquote><p>‚Ä¶, then you can choose the one that you feel makes the specification easiest to understand.</p></blockquote><p>Yes, choose the one that makes it the easiest to READ it at a future point.</p><p>Example: Someone might find it OKAY to choose (expr 3) above to express 12. Reason behind it being, ‚Äúcome on, it is not that complex!‚Äù. Especially it is not as complex as (expr 4). But when others (or the same person) read it at a future point in time, they might wonder, ‚Äúwhy didn‚Äôt we choose (expr 1) or (expr 2)‚Äù.</p><p>I have seen the equivalent of this happening in programming.</p><p>My advice for anyone (especially if you are getting started with programming and are in that phase where you get excited about different programming languages and their features) would be:</p><p>If there are two ways to express something, choose the one that will be the easiest to read and understand at a future point in time by a human and not the compiler.</p><p>~ ~ ~ ~</p><p>Optimize for reads, when writing.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;I was reading through the &lt;a href=&quot;https://lamport.azurewebsites.net/tla/book-21-07-04.pdf&quot;&gt;Specifying systems&lt;/a&gt; book few hours back wh
      
    
    </summary>
    
    
      <category term="mathematics" scheme="https://vishnubharathi.codes/tags/mathematics/"/>
    
  </entry>
  
  <entry>
    <title>Paper notes: Use of Formal Methods at Amazon Web Services</title>
    <link href="https://vishnubharathi.codes/blog/paper-notes-use-of-formal-methods-at-amazon-web-services/"/>
    <id>https://vishnubharathi.codes/blog/paper-notes-use-of-formal-methods-at-amazon-web-services/</id>
    <published>2023-11-08T22:26:53.000Z</published>
    <updated>2024-05-21T05:00:55.162Z</updated>
    
    <content type="html"><![CDATA[<p>It has been a while since I posted paper notes or anything at all in this blog. Luckily, I got curious last night about ‚ÄúHow are distributed systems tested?‚Äù. My curiosity was evoked by these factors:</p><ul><li>I keep on hearing about ‚ÄúDeterministic Simulation Testing‚Äù used in the <a href="https://github.com/tigerbeetle/tigerbeetle">TigerBeetle</a> project. I wonder what it is and what are the other methods to test distributed systems.</li><li>I have been wanting to add ‚ÄúHigh Availability‚Äù modes in <a href="https://github.com/scriptnull/waymond">my little side project</a> and I wanted to understand how to test the high availability of the system before declaring it to be highly available :D</li><li>Maybe there are some lessons that I can take away for designing and implementing different testing strategies at <a href="https://hasura.io/">my current work</a>.</li></ul><p>With those very good enough reasons, I stumbled upon <a href="https://github.com/asatarin/testing-distributed-systems">this awesome github repo</a> which curates various testing strategies for distributed systems. One of the things that stood out for me in that list was ‚ÄúFormal methods‚Äù, more specifically ‚ÄúTLA+‚Äù. It then led me to watch <a href="https://youtu.be/sPSPEgz3o9U?si=oyvODVhHCr5l7ZnQ">this awesome conference video</a> where they compare TLA+ and <a href="https://jepsen.io/">Jepsen</a>/<a href="https://github.com/jepsen-io/maelstrom">Maelstrom</a> - the video made me feel excited about both the technologies. A quick lesson from the video: TLA+ is apples and Jepsen is oranges - we would ideally want to eat both.</p><p>I then decided to learn more about TLA+ since that comes in the earlier stages of the design process. I have previously attempted to learn TLA+ but couldn‚Äôt succeed in it successfully - mainly due to a lack of motivation in the middle of the learning process. So, I wanted to be motivated enough this time before attempting to learn it again and try to use it in my side project or at work. This line of thinking made me remember that AWS had published a paper about TLA+ that I had heard of in the past. So I decided to pick it up and read it.</p><p>You can get a copy of it from <a href="https://www.amazon.science/publications/how-amazon-web-services-uses-formal-methods">here</a>.</p><h2 id="Intro"><a href="#Intro" class="headerlink" title="Intro"></a>Intro</h2><p>This paper is an experience report from the Engineers who spearheaded the moment of using formal methods to verify complex distributed systems that were getting built at AWS such as S3, Dynamodb, etc. At first, they didn‚Äôt think of formal methods and were investing in other types of testing. Those tests helped but there were still edge cases that could cause serious bugs.</p><p>They open up with the scale that they are dealing with here.</p><blockquote><p>As an example of this growth; in 2006 we launched S3, our Simple Storage Service. In the 6 years after launch, S3 grew to store 1 trillion objects [1]. Less than a year later it had grown to 2 trillion objects, and was regularly handling 1.1 million requests per second [2].</p></blockquote><p>Imagine that you were about to design a system for such a high scale and growth - how will you gain confidence about its design and correctness? If you are making any changes to the system at some point, how will you be confident about the effects of your changes?</p><p>The first line of defense in order to gain that confidence is using formal methods to specify and check your system design. Once we made sure that our design is correct, then we start to implement it and write ‚Äútests‚Äù which check the correctness of the code (this is the classic software testing bit that we are used to).</p><h2 id="Precise-Designs"><a href="#Precise-Designs" class="headerlink" title="Precise Designs"></a>Precise Designs</h2><p>What do most of us do most of the time while designing systems?</p><blockquote><p>‚Ä¶ conventional design documents consist of prose, static diagrams, and perhaps pseudo-code in an ad hoc untestable language. Such descriptions are far from precise; they are often ambiguous, or omit critical aspects such as partial failure or the granularity of concurrency (i.e. which constructs are assumed to be atomic).</p></blockquote><p>I have noticed this divergence between the reality and the design doc/diagrams in day-to-day engineering. What if we wrote something during that process of creating those beautiful diagrams and design docs - something that is more detailed and helps us down the line when we are trying to alter the system? That something turned out to be TLA+ for AWS.</p><blockquote><p>TLA+ is based on simple discrete math, i.e. basic set theory and predicates, with which all engineers are familiar. A TLA+ specification describes the set of all possible legal behaviors (execution traces) of a system.</p></blockquote><blockquote><p>TLA+ is intended to make it as easy as possible to show that a system design correctly implements the desired correctness properties, either via conventional mathematical reasoning, or more easily and quickly by using tools such as the TLC model checker [5], a tool which takes a TLA+ specification and exhaustively checks the desired correctness properties across all of the possible execution traces.</p></blockquote><blockquote><p>TLA+ is accompanied by a second language called PlusCal which is closer to a C-style programming language, but much more expressive as it uses TLA+ for expressions and values. In fact, PlusCal is intended to be a direct replacement for pseudo-code.</p></blockquote><h2 id="The-Value-of-Formal-Methods-for-‚ÄòReal-world-Systems‚Äô"><a href="#The-Value-of-Formal-Methods-for-‚ÄòReal-world-Systems‚Äô" class="headerlink" title="The Value of Formal Methods for ‚ÄòReal-world Systems‚Äô"></a>The Value of Formal Methods for ‚ÄòReal-world Systems‚Äô</h2><blockquote><p>In industry, formal methods have a reputation of requiring a huge amount of training and effort to verify a tiny piece of relatively straightforward code, so the return on investment is only justified in safety-critical domains such as medical systems and avionics. Our experience with TLA+ has shown that perception to be quite wrong.</p></blockquote><p>Excellent, that is exactly what I needed to hear. They also provided this nice table of real world things:</p><p><img src="https://github.com/scriptnull/vishnubharathi.codes/assets/4211715/fc2e094e-f7b9-4e26-b139-c99d5cc7baf8" alt="image"></p><h2 id="Side-Benefit-A-Better-Way-to-Design-Systems"><a href="#Side-Benefit-A-Better-Way-to-Design-Systems" class="headerlink" title="Side Benefit: A Better Way to Design Systems"></a>Side Benefit: A Better Way to Design Systems</h2><blockquote><p>TLA+ has been helping us shift to a better way of designing systems. Engineers naturally focus on designing the ‚Äòhappy case‚Äô for a system</p></blockquote><p>and</p><blockquote><p>Once the design for the happy case is done, the engineer then tries to think of ‚Äúwhat might go wrong?‚Äù, based on personal experience and that of colleagues and reviewers.<br>‚Ä¶. Almost always, the engineer stops well short of handling ‚Äòextremely rare‚Äô combinations of events, as there are too many such scenarios to imagine.</p></blockquote><p>and</p><blockquote><p>In contrast, when using formal specification we begin by precisely stating ‚Äúwhat needs to go right?‚Äù<br>‚Ä¶.</p><ul><li>Safety properties: ‚Äúwhat the system is allowed to do‚Äù</li><li>Liveness properties: ‚Äúwhat the system must eventually do‚Äù</li></ul></blockquote><p>After we define those properties, we will need to see if those hold true for various kind of things that can happen in the system.</p><blockquote><p>Next, with the goal of confirming that our design correctly handles all of the dynamic events in the environment, we specify the effects of each of those possible events; e.g. network errors and repairs, disk errors, process crashes and restarts, data center failures and repairs, and actions by human operators.</p></blockquote><p>So there should be a way to model these events in the system too. (The video that I mentioned at the top helped me digest this portion of the paper more easily)</p><blockquote><p>We have found this rigorous ‚Äúwhat needs to go right?‚Äù approach to be significantly less error prone than the ad hoc ‚Äúwhat might go wrong?‚Äù approach.</p></blockquote><h2 id="More-Side-Benefits-Improved-Understanding-Productivity-and-Innovation"><a href="#More-Side-Benefits-Improved-Understanding-Productivity-and-Innovation" class="headerlink" title="More Side Benefits: Improved Understanding, Productivity and Innovation"></a>More Side Benefits: Improved Understanding, Productivity and Innovation</h2><blockquote><p>In several cases we have prevented subtle, serious bugs from reaching production. In other cases we have been able to make innovative performance optimizations ‚Äì e.g. removing or narrowing locks, or weakening constraints on message ordering ‚Äì which we would not have dared to do without having model checked those changes.</p></blockquote><p>Awesome!</p><h2 id="What-Formal-Specification-Is-Not-Good-For"><a href="#What-Formal-Specification-Is-Not-Good-For" class="headerlink" title="What Formal Specification Is Not Good For"></a>What Formal Specification Is Not Good For</h2><p>They are interested in two things</p><blockquote><p>1) bugs and operator errors that cause a departure from the logical intent of the system, and</p><p>2) surprising ‚Äòsustained emergent performance degradation‚Äô of complex systems that inevitably contain feedback loops.</p></blockquote><p>(1) is achievable via formal methods but not (2). They give a good example of what (2) would look like and they mention that they have other ways to mitigate those.</p><h2 id="First-Steps-To-Formal-Methods"><a href="#First-Steps-To-Formal-Methods" class="headerlink" title="First Steps To Formal Methods"></a>First Steps To Formal Methods</h2><p>This and the upcoming sections of the paper are well narrated and I felt like I was watching a documentary movie while reading these sections.</p><p>One another option that they were considering was <a href="https://en.wikipedia.org/wiki/Alloy_(specification_language">Alloy</a>) as they found evidence of its usage.</p><blockquote><p>Zave used a language called Alloy to find serious bugs in the membership protocol of a distributed system called Chord. Chord was designed by a strong group at MIT and is certainly successful; it won a ‚Äô10-year test of time‚Äô award at SIGCOMM 2011</p></blockquote><p>But they chose TLA+ over Alloy as it was not as expressive as they needed it to be.</p><blockquote><p>Eventually C.N. stumbled across a language with those properties when he found a TLA+ specification in the appendix of a paper on a canonical algorithm in our problem domain: the Paxos consensus algorithm</p><p>The fact that TLA+ was created by the designer of such a widely used algorithm gave us some confidence that TLA+ worked for real-world systems.</p></blockquote><p>Yeah, TLA+ was invented by <a href="https://en.wikipedia.org/wiki/Leslie_Lamport">Leslie Lamport</a> who given us with some of the coolest research that are getting used in a lot of stuff.</p><h2 id="First-Big-Success-at-Amazon"><a href="#First-Big-Success-at-Amazon" class="headerlink" title="First Big Success at Amazon"></a>First Big Success at Amazon</h2><blockquote><p>T.R. says that, had he known about TLA+ before starting work on DynamoDB, he would have used it from the start. He believes that the investment he made in writing and checking the formal TLA+ specifications was both more reliable, and also less time consuming than the work he put into writing and checking his informal proofs.</p></blockquote><h2 id="Persuading-More-Engineers-Leads-to-Further-Successes"><a href="#Persuading-More-Engineers-Leads-to-Further-Successes" class="headerlink" title="Persuading More Engineers Leads to Further Successes"></a>Persuading More Engineers Leads to Further Successes</h2><p>Totally love this section. I would use the techniques mentioned here if I were to introduce formal methods and verification to other engineers.</p><blockquote><p>This raised a challenge; how to convey the purpose and benefits of formal methods to an audience of software engineers? Engineers think in terms of debugging rather than ‚Äòverification‚Äô, so we called the presentation ‚ÄúDebugging Designs‚Äù</p></blockquote><p>and</p><blockquote><p>Continuing that metaphor, we have found that software engineers more readily grasp the concept and practical value of TLA+ if we dub it:</p><p>Exhaustively testable pseudo-code</p></blockquote><p>One another thing that I saw that I didn‚Äôt expect was</p><blockquote><p>Most recently we discovered that TLA+ is an excellent tool for data modeling, e.g. designing the schema for a relational or ‚ÄòNo SQL‚Äô database.</p></blockquote><p>Wow, his helped them in coming up with a better schema!</p><h2 id="The-Most-Frequently-Asked-Question"><a href="#The-Most-Frequently-Asked-Question" class="headerlink" title="The Most Frequently Asked Question"></a>The Most Frequently Asked Question</h2><blockquote><p>‚ÄúHow do we know that the executable code correctly implements the verified design?‚Äù</p></blockquote><p>We don‚Äôt, but</p><blockquote><p>Formal methods help engineers to get the design right, which is a necessary first step toward getting the code right. If the design is broken then the code is almost certainly broken, as mistakes during coding are extremely unlikely to compensate for mistakes in design. Worse, engineers will probably be deceived into believing that the code is ‚Äòcorrect‚Äô because it appears to correctly implement the (broken) design. Engineers are unlikely to realize that the design is incorrect while they are focusing on coding.</p></blockquote><h2 id="Alternatives-to-TLA"><a href="#Alternatives-to-TLA" class="headerlink" title="Alternatives to TLA+"></a>Alternatives to TLA+</h2><p>Seems like they published a whole other paper on this topic.</p><blockquote><p>When we found that TLA+ met those requirements, we stopped evaluating methods, as our goal was always practical engineering rather than an exhaustive survey.</p></blockquote><h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>I hope you enjoyed this post and got the urge to explore and learn TLA+ - I feel this has the power to change the way we think and reason about our systems. I hope to write up more when I try to use it in real-world situations.</p><p>From here, I would like to read <a href="https://brooker.co.za/blog/2013/01/20/two-phase.html">this</a> which was one of the references from that paper and try to learn and write TLA+ for something(s).</p><blockquote><p>Formal methods deal with models of systems, not the systems themselves, so the adage applies;</p><p>‚ÄúAll models are wrong, some are useful.‚Äù</p></blockquote><p>~ ~ ~</p><p>oh, and TLA is an acronym for <a href="https://en.wikipedia.org/wiki/Temporal_logic_of_actions">Temporal logic of actions</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;It has been a while since I posted paper notes or anything at all in this blog. Luckily, I got curious last night about ‚ÄúHow are distribu
      
    
    </summary>
    
    
      <category term="research papers" scheme="https://vishnubharathi.codes/tags/research-papers/"/>
    
  </entry>
  
  <entry>
    <title>Double Bongos</title>
    <link href="https://vishnubharathi.codes/blog/double-bongos/"/>
    <id>https://vishnubharathi.codes/blog/double-bongos/</id>
    <published>2023-06-10T22:14:42.000Z</published>
    <updated>2024-05-21T05:00:55.154Z</updated>
    
    <content type="html"><![CDATA[<p>I was re-watching this amazing musical stand-up comedy show called <a href="https://www.imdb.com/title/tt10915930/">‚ÄúAlex in Wonderland‚Äù</a> in Amazon Primevideo tonight. It is one of a kind show. I have never seen or felt anything like this. It is a beautiful walk through the history of Tamil music industry from 1940s to up until now. The host ‚ÄúAlexander Babu‚Äù is definintely super-talented. Thanks to him: He taught me a different way to listen and taste music and helped me rediscover my passion in listening to music. He will fill your eyes with tears one second and make you laugh the next second. The transition happens so fast - I can‚Äôt believe how he does it.</p><p>I want to share a particular section which WOWed me. If you know Tamil and have an Amazon Primevideo account, search for ‚ÄúAlex in Wonderland‚Äù and go to the 58th minute of the show. For the rest of you people, I have typed in the bits that I wanted to share with you:</p><p>Alex says:</p><blockquote><p>Think about this simple instrument</p><p>You know the name of this instrument?</p><p>It is called the Double Bongos right?</p><p>One of the simplest percussion rhythm instruments.</p><p>And you can buy this for 700 ruppees in Chennai even today.</p><p>And will you belive if I say this simple instrument ruled Tamil Film Music for half a century man?</p><p>I am not exaggerating.</p><p>For 50 years every other super hit song that came in Tamil film music had only this instrument as the core rhythm instrument.</p><p>This sound I‚Äôm sure you can all recall‚Ä¶‚Ä¶.</p><p>(plays the double bongos)</p><p>This sound ruled Tamil film music for half a century.</p><p>This music director we all adore. He will live forever. He‚Äôs living forever.</p><p>He made amazing, wonderful, soulful songs.</p><p>The melodies will be out of the world.</p><p>But the percussion: just bongos and nothing else.</p><p>Of-course I am talking about the King of Melodies ‚ÄúM S Viswanathan‚Äù (fondly called MSV)</p><p>I think MSV wants to tell us one thing very clearly.</p><p>Beauty lies in simplicity.</p><p>Even on Bongos he wouldn‚Äôt complicate.</p><p>He would not go into the complex rhythm patterns and all.</p><p>Just the 4-beat rhythm for every song ya.</p><p>This four beat: one, two, three, four, that‚Äôs all.</p><p>Whatever maybe the situation. Whatever maybe the emotion that he has to show. Anything that ever happens in any story, for anybody‚Äôs life, MSV has captured anything and everything in this 4-beat rhythm.</p><p>one two three four.</p></blockquote><p>(Alex sings some of the super-hit MSV songs by live-playing the four beats on double bongos)</p><p>Just WOW. These songs have been heard millions of times by a lot of people. I myself had heard them but never noticed this basic construct. That‚Äôs why I thanked Alex at the start of this post. We could not taste the essense of music without people like him.</p><p>If you are curious, here is a small playlist of MSV‚Äôs songs that Alex performs to demonstrate the double bongos.</p><iframe style="border-radius:12px" src="https://open.spotify.com/embed/playlist/6QoFkkY3JyeslWhlHE4BVG?utm_source=generator" width="100%" height="352" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe><p>Notice how thoughtfully the bongos hit in at the start of each song. They continue in harmony throughout every song.</p><p>This got me thinking and inspired. I think the lessons for me (and any of us reading this) are</p><h3 id="Beauty-lies-in-simplicity"><a href="#Beauty-lies-in-simplicity" class="headerlink" title="Beauty lies in simplicity"></a>Beauty lies in simplicity</h3><p>We are talking about a legend here. At the core of his compositions lies this touch of simplicity. How beautiful! A little simplicity has a lot of mileage (50 years). MSV retired and didn‚Äôt compose songs for movies for over 20 years in his retirement. But as Alex bets, if he had composed during that time, the magic would have still worked!</p><p>I am already a fan of ‚ÄúSimplicity‚Äù - the reason I prefer using Go programming language a lot :D Simplcity is not easy, but trying to get there is well worth it. (Obligatory link to the famous tech talk on this subject <a href="https://www.infoq.com/presentations/Simple-Made-Easy/">here</a>).</p><h3 id="You-don‚Äôt-need-costly-gadgets"><a href="#You-don‚Äôt-need-costly-gadgets" class="headerlink" title="You don‚Äôt need costly gadgets"></a>You don‚Äôt need costly gadgets</h3><p>I searched Amazon for the double bongos and it still costs 700 Indian Ruppees. That is equal to 8.49 USD.</p><p>Crazy, right? MSV was able to produce legendary music with it.</p><p>I always advice myself and people to not worry about not having enough money to afford something to make progress in an area.</p><p>Learning programming? You don‚Äôt need that latest expensive MacBook Pro or whatever. All you need is a <a href="https://www.raspberrypi.org">Raspberry Pi</a> running linux.</p><p>~ ~ ~ ~</p><p>oh, and don‚Äôt forget the four beats of the double bongos.</p><p>one, two, three, four.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;I was re-watching this amazing musical stand-up comedy show called &lt;a href=&quot;https://www.imdb.com/title/tt10915930/&quot;&gt;‚ÄúAlex in Wonderland‚Äù&lt;
      
    
    </summary>
    
    
      <category term="music" scheme="https://vishnubharathi.codes/tags/music/"/>
    
      <category term="inspiration" scheme="https://vishnubharathi.codes/tags/inspiration/"/>
    
  </entry>
  
</feed>
